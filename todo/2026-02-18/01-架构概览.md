# Lynx 微服务框架架构概览

## 框架定位

Lynx 是一个轻量级 Go 微服务框架，基于 Go 1.24.2+ 构建，提供：
- 应用生命周期管理
- 组件化架构
- HTTP/gRPC 服务器集成
- 消息队列支持 (Kafka/PubSub)
- 定时任务调度
- Wire 依赖注入模式

## 目录结构

```
lynx (核心框架)
├── lynx.go           - 应用核心、CLI、生命周期管理
├── lynx_test.go      - (缺失) 单元测试
├── component.go      - Component/ServerLike 接口定义
├── hooks.go          - 生命周期钩子系统
├── cli.go            - CLI 入口封装
├── command.go        - CLI 命令执行组件
├── health.go         - 健康检查接口
├── options.go        - 应用选项配置
├── server/
│   ├── http/
│   │   ├── server.go      - HTTP 服务器 (gocloud.dev/server)
│   │   └── requestlog.go  - 请求日志记录器
│   └── grpc/
│       ├── server.go      - gRPC 服务器
│       └── interceptor/   - 拦截器 (日志、恢复)
├── contrib/
│   ├── zap/          - Zap 日志集成
│   ├── pubsub/       - 消息抽象层 (Watermill)
│   ├── kafka/        - Kafka 实现
│   └── schedule/     - 定时任务调度
├── boot/             - Wire 依赖注入模式
└── pkg/errors/       - 本地错误包 (带 Fatal)
```

## 核心设计模式

### 1. Functional Options Pattern (函数选项模式)

广泛应用于各模块配置：

```go
// lynx.go 示例
type Option func(*Options)

func WithName(name string) Option {
    return func(o *Options) { o.Name = name }
}

// 使用方式
app := lynx.New(lynx.WithName("my-service"))
```

**应用位置：**
- `lynx.go` - 应用选项
- `server/http/server.go` - HTTP 服务器选项
- `server/grpc/server.go` - gRPC 服务器选项
- `contrib/schedule/scheduler.go` - 调度器选项

### 2. Factory Pattern (工厂模式)

通过 `ComponentBuilder` 实现动态组件创建：

```go
// component.go:24-27
type ComponentBuilder interface {
    Build() Component
    Options() BuildOptions
}

type BuildOptions struct {
    Instances int `json:"instances"` // 实例数
}
```

支持创建多个相同类型的组件实例。

### 3. Actor Model (Actor 模型)

使用 `oklog/run.Group` 管理并发 goroutine：

```go
// lynx.go:224-231
app.runG.Add(func() error {
    log.InfoContext(ctx, "starting component", "component", component.Name())
    return component.Start(ctx)
}, func(err error) {
    log.InfoContext(ctx, "stopping component", "component", component.Name())
    component.Stop(ctx)
    cancel()
})
```

每个组件作为独立 actor 运行，拥有自己的生命周期。

### 4. Dependency Injection (依赖注入)

通过 Wire 实现编译期依赖注入：

```go
// _examples/boot/wire.go
//go:build wireinject

func InitializeApp(ctx context.Context) (*App, func(), error) {
    wire.Build(ProviderSet)
    return nil, nil, nil
}
```

## 核心接口

### Component 接口

```go
// component.go:15-18
type Component interface {
    Name() string
    LifecycleManaged
}

type LifecycleManaged interface {
    Init(app Lynx) error
    Start(ctx context.Context) error
    Stop(ctx context.Context)
}
```

### ServerLike 接口

```go
// component.go:41-44
type ServerLike interface {
    health.Checker
    Component
}
```

组合了健康检查和组件接口。

### Lynx 主接口

```go
// lynx.go:20-41
type Lynx interface {
    Close()
    Config() *viper.Viper
    Context() context.Context
    CLI(cmd CommandFunc) error
    Hooks(hooks ...HookOption) error
    HealthCheckFunc() HealthCheckFunc
    Run() error
    SetLogger(logger *slog.Logger)
    Logger(kwargs ...any) *slog.Logger
}
```

## 生命周期流程

```
┌─────────────────────────────────────────────────────────────┐
│                      Application Startup                     │
├─────────────────────────────────────────────────────────────┤
│  1. newLynx() → init() → initConfigure()                    │
│  2. Parse flags, bind config, read config file              │
│  3. Set context values (name, id, version)                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Hooks Registration                      │
├─────────────────────────────────────────────────────────────┤
│  app.Hooks(                                                  │
│      lynx.OnStart(...),    // 启动钩子                       │
│      lynx.OnStop(...),     // 停止钩子                       │
│      lynx.Components(...), // 组件注册                       │
│  )                                                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Component Initialization                  │
├─────────────────────────────────────────────────────────────┤
│  for each component:                                         │
│      component.Init(app)  // 初始化                          │
│      runG.Add(Start, Stop) // 注册到 run.Group               │
│      if health.Checker: register health check               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Run Loop (oklog/run)                    │
├─────────────────────────────────────────────────────────────┤
│  Concurrent actors:                                          │
│  ├── OnStart hooks actor                                    │
│  ├── Signal handler actor (SIGTERM, SIGQUIT, SIGINT)        │
│  └── Component actors (each in own goroutine)               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Graceful Shutdown                        │
├─────────────────────────────────────────────────────────────┤
│  1. Signal received or context cancelled                    │
│  2. Execute interrupt functions (reverse order):            │
│     - OnStop hooks                                          │
│     - Component.Stop() for each component                   │
│  3. Exit                                                    │
└─────────────────────────────────────────────────────────────┘
```

## 配置系统

使用 Viper + pflag 组合：

```
配置优先级 (高到低):
1. CLI flags (--config, --log-level 等)
2. 环境变量
3. 配置文件 (yaml/json/toml)
4. 默认值
```

默认 flags (lynx.go:140-145):
- `--config/-c` - 配置文件路径
- `--config-type` - 文件类型 (默认 yaml)
- `--config-dir` - 配置目录
- `--log-level` - 日志级别 (默认 info)

## Context 值传递

应用上下文携带标准值：

```go
// lynx.go:55-65
func IDFromContext(ctx context.Context) string      // 实例 ID
func VersionFromContext(ctx context.Context) string // 应用版本
func NameFromContext(ctx context.Context) string    // 应用名称
```

## 组件健康检查

组件实现 `health.Checker` 接口后自动注册：

```go
// lynx.go:232-234
if hc, ok := component.(health.Checker); ok {
    app.healthCheckers = append(app.healthCheckers, hc)
}
```

HTTP 服务器暴露在 `/health`，gRPC 使用 `grpc.health.v1.Health`。

## 外部依赖

| 依赖 | 用途 |
|------|------|
| `oklog/run` | 并发 goroutine 管理 |
| `spf13/viper` | 配置管理 |
| `spf13/pflag` | CLI 参数解析 |
| `gocloud.dev/server` | HTTP 服务器基础 |
| `google.golang.org/grpc` | gRPC 服务器 |
| `robfig/cron` | 定时任务调度 |
| `uber-go/zap` | 高性能日志 |
| `google/wire` | 依赖注入代码生成 |
| `cenkalti/backoff` | 重试退避策略 |
| `watermill` | 消息队列抽象 |

## 设计亮点

1. **简洁的组件模型** - 单一 `Component` 接口统一所有组件
2. **优雅的生命周期** - 通过 `run.Group` 实现并发启动/停止
3. **灵活的钩子系统** - 支持任意数量的 OnStart/OnStop 回调
4. **标准化的健康检查** - 自动发现和注册健康检查器
5. **模块化设计** - 核心与 contrib 分离，易于扩展
