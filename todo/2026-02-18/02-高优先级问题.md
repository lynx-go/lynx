# é«˜ä¼˜å…ˆçº§é—®é¢˜

è¿™äº›é—®é¢˜å¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒã€æ•°æ®ç«žäº‰æˆ–ä¸å¯é¢„æµ‹çš„è¡Œä¸ºï¼Œå»ºè®®ä¼˜å…ˆä¿®å¤ã€‚

---

## é—®é¢˜ 1: Fatal æ»¥ç”¨ (ä¸¥é‡)

### ä½ç½®
- `lynx.go:163` - `errors.Fatal(app.f.Parse(os.Args[1:]))`
- `lynx.go:171` - `errors.Fatal(app.c.ReadInConfig())`
- `lynx.go:175` - `errors.Fatal(app.c.BindPFlags(app.f))`
- `lynx.go:295` - `errors.Fatal(app.init())`

### é—®é¢˜æè¿°

åº“ä»£ç ä¸­ä½¿ç”¨ `errors.Fatal()` ç›´æŽ¥è°ƒç”¨ `os.Exit(1)`ï¼Œè¿åäº†åº“ä»£ç ä¸åº”ä¸»åŠ¨é€€å‡ºç¨‹åºçš„åŽŸåˆ™ã€‚

```go
// lynx.go:160-179
func (app *lynx) initConfigure() error {
    if fn := app.o.SetFlagsFunc; fn != nil {
        fn(app.f)
        errors.Fatal(app.f.Parse(os.Args[1:]))  // âŒ ç›´æŽ¥é€€å‡º
    }

    if fn := app.o.BindConfigFunc; fn != nil {
        if err := fn(app.f, app.c); err != nil {
            return err
        }
        errors.Fatal(app.c.ReadInConfig())  // âŒ ç›´æŽ¥é€€å‡º
    }

    if app.o.SetFlagsFunc != nil {
        errors.Fatal(app.c.BindPFlags(app.f))  // âŒ ç›´æŽ¥é€€å‡º
    }
    return nil
}
```

### å½±å“

1. **ä¸å¯æµ‹è¯•** - å•å…ƒæµ‹è¯•ä¸­æ— æ³•æ•èŽ·è¿™ä¸ªé”™è¯¯
2. **è°ƒç”¨è€…æ— æ³•å¤„ç†** - ä¸Šå±‚ä»£ç æ— æ³•å†³å®šå¦‚ä½•å¤„ç†é”™è¯¯
3. **è°ƒè¯•å›°éš¾** - æ— æ³•èŽ·å–é”™è¯¯è¯¦æƒ…è¿›è¡Œè°ƒè¯•
4. **è¿å Go æƒ¯ä¾‹** - åº“ä»£ç åº”è¿”å›žé”™è¯¯è€Œéžé€€å‡º

### ä¿®å¤å»ºè®®

```go
func (app *lynx) initConfigure() error {
    if fn := app.o.SetFlagsFunc; fn != nil {
        fn(app.f)
        if err := app.f.Parse(os.Args[1:]); err != nil {
            return fmt.Errorf("failed to parse flags: %w", err)
        }
    }

    if fn := app.o.BindConfigFunc; fn != nil {
        if err := fn(app.f, app.c); err != nil {
            return err
        }
        if err := app.c.ReadInConfig(); err != nil {
            return fmt.Errorf("failed to read config: %w", err)
        }
    }

    if app.o.SetFlagsFunc != nil {
        if err := app.c.BindPFlags(app.f); err != nil {
            return fmt.Errorf("failed to bind flags: %w", err)
        }
    }
    return nil
}

// newLynx ä¸­ä¹Ÿéœ€è¦ä¿®æ”¹
func newLynx(o *Options) (Lynx, error) {
    o.EnsureDefaults()
    app := &lynx{...}
    app.ctx, app.cancelCtx = context.WithCancel(context.Background())
    if err := app.init(); err != nil {
        return nil, err  // è¿”å›žé”™è¯¯è€Œéž Fatal
    }
    return app, nil
}
```

---

## é—®é¢˜ 2: å¹¶å‘ä¸å®‰å…¨ (ä¸¥é‡)

### ä½ç½®
- `lynx.go:85-86` - `app.hooks.onStarts/OnStops` åˆ‡ç‰‡è¿½åŠ 
- `lynx.go:232-234` - `app.healthCheckers` åˆ‡ç‰‡è¿½åŠ 

### é—®é¢˜æè¿°

`hooks` åˆ‡ç‰‡å’Œ `healthCheckers` åˆ‡ç‰‡åœ¨å¹¶å‘è®¿é—®æ—¶ä¸å®‰å…¨ï¼š

```go
// lynx.go:67-77
type lynx struct {
    *hooks
    o              *Options
    f              *pflag.FlagSet
    c              *viper.Viper
    ctx            context.Context
    cancelCtx      context.CancelFunc
    runG           *run.Group
    logger         *slog.Logger
    healthCheckers []health.Checker  // âŒ æ— é”ä¿æŠ¤
}

// lynx.go:79-95
func (app *lynx) Hooks(hooks ...HookOption) error {
    options := &hookOptions{}
    for _, hook := range hooks {
        hook(options)
    }

    app.hooks.onStarts = append(app.hooks.onStarts, options.onStarts...)  // âŒ ç«žæ€
    app.hooks.onStops = append(app.hooks.onStops, options.onStops...)      // âŒ ç«žæ€
    // ...
}

// lynx.go:232-234
if hc, ok := component.(health.Checker); ok {
    app.healthCheckers = append(app.healthCheckers, hc)  // âŒ ç«žæ€
}
```

### å½±å“

1. **æ•°æ®ç«žäº‰** - å¤š goroutine åŒæ—¶è°ƒç”¨ `Hooks()` æˆ–æ·»åŠ ç»„ä»¶
2. **ä¸å¯é¢„æµ‹è¡Œä¸º** - å¯èƒ½å¯¼è‡´åˆ‡ç‰‡æŸåæˆ–æ•°æ®ä¸¢å¤±
3. **éš¾ä»¥è°ƒè¯•** - ç«žæ€æ¡ä»¶éš¾ä»¥å¤çŽ°

### ä¿®å¤å»ºè®®

```go
import "sync"

type lynx struct {
    *hooks
    mu              sync.Mutex  // æ·»åŠ äº’æ–¥é”
    o               *Options
    f               *pflag.FlagSet
    c               *viper.Viper
    ctx             context.Context
    cancelCtx       context.CancelFunc
    runG            *run.Group
    logger          *slog.Logger
    healthCheckers  []health.Checker
}

func (app *lynx) Hooks(hooks ...HookOption) error {
    app.mu.Lock()
    defer app.mu.Unlock()

    options := &hookOptions{}
    for _, hook := range hooks {
        hook(options)
    }

    app.hooks.onStarts = append(app.hooks.onStarts, options.onStarts...)
    app.hooks.onStops = append(app.hooks.onStops, options.onStops...)
    // ...
}

func (app *lynx) addComponents(components ...Component) error {
    app.mu.Lock()
    defer app.mu.Unlock()

    for _, component := range components {
        // ... åˆå§‹åŒ–é€»è¾‘
        if hc, ok := component.(health.Checker); ok {
            app.healthCheckers = append(app.healthCheckers, hc)
        }
    }
    return nil
}
```

---

## é—®é¢˜ 3: Context ç±»åž‹æ–­è¨€å¯èƒ½ Panic (é«˜)

### ä½ç½®
- `lynx.go:55-57` - `IDFromContext`
- `lynx.go:59-61` - `VersionFromContext`
- `lynx.go:63-65` - `NameFromContext`

### é—®é¢˜æè¿°

ç›´æŽ¥ç±»åž‹æ–­è¨€åœ¨å€¼ä¸å­˜åœ¨æˆ–ç±»åž‹ä¸åŒ¹é…æ—¶ä¼š panicï¼š

```go
// lynx.go:55-57
func IDFromContext(ctx context.Context) string {
    return ctx.Value(keyId).(string)  // âŒ å¦‚æžœå€¼ä¸å­˜åœ¨ä¼š panic
}
```

### å½±å“

1. **ç¨‹åºå´©æºƒ** - ä½¿ç”¨é”™è¯¯çš„ context ä¼šå¯¼è‡´ panic
2. **éš¾ä»¥é˜²å¾¡** - è°ƒç”¨è€…æ— æ³•é¢„å…ˆæ£€æŸ¥
3. **åº“ä»£ç é£Žé™©** - ä½œä¸ºåº“ï¼Œä¸åº”å› è¾“å…¥é—®é¢˜è€Œ panic

### ä¿®å¤å»ºè®®

```go
// æ–¹æ¡ˆ 1: è¿”å›žé»˜è®¤å€¼ (æŽ¨èç”¨äºŽå¤§å¤šæ•°åœºæ™¯)
func IDFromContext(ctx context.Context) string {
    if v := ctx.Value(keyId); v != nil {
        if s, ok := v.(string); ok {
            return s
        }
    }
    return ""  // æˆ–è¿”å›žé»˜è®¤å€¼å¦‚ "unknown"
}

// æ–¹æ¡ˆ 2: è¿”å›žé”™è¯¯
func IDFromContextE(ctx context.Context) (string, error) {
    if v := ctx.Value(keyId); v != nil {
        if s, ok := v.(string); ok {
            return s, nil
        }
    }
    return "", errors.New("id not found in context")
}

// æ–¹æ¡ˆ 3: è¿”å›žå¸¦ ok çš„ç‰ˆæœ¬
func IDFromContextOk(ctx context.Context) (string, bool) {
    if v := ctx.Value(keyId); v != nil {
        if s, ok := v.(string); ok {
            return s, true
        }
    }
    return "", false
}
```

---

## é—®é¢˜ 4: è¶…æ—¶é…ç½®æœªç”Ÿæ•ˆ (ä¸­é«˜)

### ä½ç½®
- `server/http/server.go:21,62` - `Timeout` å­—æ®µå®šä¹‰ä½†æœªä½¿ç”¨
- `server/grpc/server.go:22,55` - `Timeout` å­—æ®µå®šä¹‰ä½†æœªä½¿ç”¨

### é—®é¢˜æè¿°

`Timeout` é€‰é¡¹å­—æ®µåœ¨ä¸¤ä¸ªæœåŠ¡å™¨å®žçŽ°ä¸­éƒ½å®šä¹‰äº†ï¼Œä½†ä»Žæœªå®žé™…ä½¿ç”¨ï¼š

```go
// server/http/server.go:19-25
type Options struct {
    Addr        string
    Timeout     time.Duration  // âŒ ä»Žæœªä½¿ç”¨
    HealthCheck lynx.HealthCheckFunc
    Logger      *slog.Logger
    RequestLog  bool
}

// server/grpc/server.go:19-24
type Options struct {
    Addr         string
    Timeout      time.Duration  // âŒ ä»Žæœªä½¿ç”¨
    Logger       *slog.Logger
    Interceptors []grpc.UnaryServerInterceptor
}
```

### å½±å“

1. **è¯¯å¯¼æ€§ API** - ç”¨æˆ·ä»¥ä¸ºé…ç½®äº†è¶…æ—¶ï¼Œå®žé™…æ— æ•ˆ
2. **åŠŸèƒ½ç¼ºå¤±** - æ— æ³•æŽ§åˆ¶è¯·æ±‚/è¿žæŽ¥è¶…æ—¶
3. **æ–‡æ¡£ä¸ä¸€è‡´** - API ä¸Žå®žé™…è¡Œä¸ºä¸ç¬¦

### ä¿®å¤å»ºè®®

**HTTP Server:**

```go
func (s *Server) Start(ctx context.Context) error {
    log.InfoContext(ctx, "starting HTTP server, listening on "+s.o.Addr)
    var healthChecks []health.Checker
    if s.o.HealthCheck != nil {
        healthChecks = s.o.HealthCheck()
    }

    opts := &server.Options{
        HealthChecks: healthChecks,
        Driver:       server.NewDefaultDriver(),
    }

    // åº”ç”¨è¶…æ—¶é…ç½®
    if s.o.Timeout > 0 {
        opts.RequestTimeout = s.o.Timeout
        // æˆ–ä½¿ç”¨ http.Server çš„è¶…æ—¶è®¾ç½®
    }

    if s.o.RequestLog {
        opts.RequestLogger = NewRequestLogger(s.logger, func(err error) {
            log.ErrorContext(ctx, "failed to log HTTP request", err)
        })
    }

    hs := server.New(s.handler, opts)
    s.Server = hs
    return s.Server.ListenAndServe(s.o.Addr)
}
```

**gRPC Server:**

```go
func (s *Server) Stop(ctx context.Context) {
    log.InfoContext(ctx, "stopping gRPC server")
    if s.health != nil {
        s.health.SetServingStatus("grpc", grpc_health_v1.HealthCheckResponse_NOT_SERVING)
    }
    s.running.Store(false)
    if s.server != nil {
        // ä½¿ç”¨ context æŽ§åˆ¶è¶…æ—¶
        done := make(chan struct{})
        go func() {
            s.server.GracefulStop()
            close(done)
        }()

        select {
        case <-done:
            // æ­£å¸¸å…³é—­å®Œæˆ
        case <-ctx.Done():
            // è¶…æ—¶ï¼Œå¼ºåˆ¶å…³é—­
            s.logger.Warn("graceful stop timeout, forcing stop")
            s.server.Stop()
        }
    }
}
```

---

## é—®é¢˜ 5: gRPC GracefulStop å¿½ç•¥ Context (ä¸­é«˜)

### ä½ç½®
- `server/grpc/server.go:127-136`

### é—®é¢˜æè¿°

gRPC çš„ `GracefulStop()` ä¸æŽ¥å— context å‚æ•°ï¼Œå½“å‰å®žçŽ°æ— æ³•å¼ºåˆ¶è¶…æ—¶å…³é—­ï¼š

```go
// server/grpc/server.go:127-136
func (s *Server) Stop(ctx context.Context) {
    log.InfoContext(ctx, "stopping gRPC server")
    if s.health != nil {
        s.health.SetServingStatus("grpc", grpc_health_v1.HealthCheckResponse_NOT_SERVING)
    }
    s.running.Store(false)
    if s.server != nil {
        s.server.GracefulStop()  // âŒ æ— é™ç­‰å¾…ï¼Œå¿½ç•¥ context
    }
}
```

### å½±å“

1. **æ— æ³•å¼ºåˆ¶å…³é—­** - å¦‚æžœæœ‰é•¿è¿žæŽ¥è¯·æ±‚ï¼Œå¯èƒ½å¯¼è‡´å…³é—­æŒ‚èµ·
2. **K8s çŽ¯å¢ƒé—®é¢˜** - Pod ç»ˆæ­¢å¯èƒ½è¶…æ—¶è¢«å¼ºåˆ¶æ€æ­»
3. **èµ„æºæ³„æ¼** - æ— æ³•åœ¨æŒ‡å®šæ—¶é—´å†…é‡Šæ”¾èµ„æº

### ä¿®å¤å»ºè®®

```go
func (s *Server) Stop(ctx context.Context) {
    log.InfoContext(ctx, "stopping gRPC server")

    // 1. å…ˆæ ‡è®°ä¸ºä¸å¥åº·
    if s.health != nil {
        s.health.SetServingStatus("grpc", grpc_health_v1.HealthCheckResponse_NOT_SERVING)
    }
    s.running.Store(false)

    if s.server == nil {
        return
    }

    // 2. å°è¯•ä¼˜é›…å…³é—­
    done := make(chan struct{})
    go func() {
        defer close(done)
        s.server.GracefulStop()
    }()

    // 3. ç­‰å¾…å…³é—­æˆ– context è¶…æ—¶
    select {
    case <-done:
        s.logger.Info("gRPC server stopped gracefully")
    case <-ctx.Done():
        s.logger.Warn("graceful stop timeout, forcing stop")
        s.server.Stop()  // å¼ºåˆ¶å…³é—­
        <-done  // ç­‰å¾… GracefulStop goroutine ç»“æŸ
    }
}
```

---

## é—®é¢˜æ±‡æ€»è¡¨

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | å½±å“ | ä¿®å¤éš¾åº¦ |
|------|---------|------|---------|
| Fatal æ»¥ç”¨ | ðŸ”´ é«˜ | ç¨‹åºæ— æ³•æ­£å¸¸é€€å‡ºï¼Œä¸å¯æµ‹è¯• | ä¸­ |
| å¹¶å‘ä¸å®‰å…¨ | ðŸ”´ é«˜ | æ•°æ®ç«žäº‰ï¼Œä¸å¯é¢„æµ‹è¡Œä¸º | ä½Ž |
| Context ç±»åž‹æ–­è¨€ | ðŸŸ  ä¸­é«˜ | å¯èƒ½å¯¼è‡´ panic | ä½Ž |
| è¶…æ—¶é…ç½®æœªç”Ÿæ•ˆ | ðŸŸ  ä¸­é«˜ | è¯¯å¯¼æ€§ API | ä½Ž |
| gRPC GracefulStop | ðŸŸ  ä¸­é«˜ | å…³é—­æŒ‚èµ· | ä¸­ |

---

## ä¿®å¤ä¼˜å…ˆçº§

1. **ç«‹å³ä¿®å¤** (Phase 1)
   - Fatal æ»¥ç”¨ â†’ è¿”å›žé”™è¯¯
   - å¹¶å‘å®‰å…¨ â†’ æ·»åŠ äº’æ–¥é”

2. **çŸ­æœŸä¿®å¤** (Phase 2)
   - Context ç±»åž‹æ–­è¨€ â†’ å®‰å…¨èŽ·å–
   - gRPC GracefulStop â†’ context æŽ§åˆ¶

3. **è®¡åˆ’ä¿®å¤** (Phase 3)
   - è¶…æ—¶é…ç½® â†’ å®žé™…ç”Ÿæ•ˆ
